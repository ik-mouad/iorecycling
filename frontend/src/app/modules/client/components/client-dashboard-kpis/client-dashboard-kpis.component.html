<div class="dashboard-container">
  <h1>Tableau de Bord</h1>

  <!-- Filtres de p√©riode -->
  <mat-card class="filter-card">
    <mat-card-content>
      <form [formGroup]="filterForm" class="filter-form">
        <mat-form-field appearance="outline">
          <mat-label>P√©riode</mat-label>
          <mat-select formControlName="periode">
            <mat-option *ngFor="let p of periodesPredefinies" [value]="p.value">
              {{ p.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="isPersonnalise()">
          <mat-label>Date de d√©but</mat-label>
          <input matInput [matDatepicker]="pickerDebut" formControlName="dateDebut">
          <mat-datepicker-toggle matIconSuffix [for]="pickerDebut"></mat-datepicker-toggle>
          <mat-datepicker #pickerDebut></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="isPersonnalise()">
          <mat-label>Date de fin</mat-label>
          <input matInput [matDatepicker]="pickerFin" formControlName="dateFin">
          <mat-datepicker-toggle matIconSuffix [for]="pickerFin"></mat-datepicker-toggle>
          <mat-datepicker #pickerFin></mat-datepicker>
        </mat-form-field>

        <button mat-raised-button color="primary" (click)="applyCustomPeriod()" *ngIf="isPersonnalise()">
          Appliquer
        </button>
      </form>
    </mat-card-content>
  </mat-card>

  <div *ngIf="loading" class="loading">Chargement...</div>

  <div *ngIf="kpis && !loading" class="kpis-grid">
    
    <!-- KPI 1 : Prochain enl√®vement -->
    <mat-card class="kpi-card kpi-prochain">
      <mat-card-header>
        <mat-icon>event</mat-icon>
        <mat-card-title>Prochain enl√®vement</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="kpis.prochainEnlevement; else noProchainEnlevement">
          <div class="date-prevue">{{ kpis.prochainEnlevement.datePrevue | date:'dd/MM/yyyy' }}</div>
          <div class="site-info">üìç {{ kpis.prochainEnlevement.siteNom }}</div>
          <div class="heure-info" *ngIf="kpis.prochainEnlevement.heurePrevue">
            ‚è∞ {{ kpis.prochainEnlevement.heurePrevue }}
          </div>
        </div>
        <ng-template #noProchainEnlevement>
          <div class="no-data">Aucun enl√®vement programm√©</div>
        </ng-template>
      </mat-card-content>
    </mat-card>

    <!-- KPI 3 : Nombre d'enl√®vements -->
    <mat-card class="kpi-card kpi-count">
      <mat-card-header>
        <mat-icon>local_shipping</mat-icon>
        <mat-card-title>Enl√®vements effectu√©s</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="kpi-value">{{ kpis.nombreEnlevements }}</div>
        <div class="kpi-subtitle">Moyenne : {{ kpis.moyenneParSemaine | number:'1.1-1' }} / semaine</div>
      </mat-card-content>
    </mat-card>

    <!-- KPI 4 : Budget valorisation -->
    <mat-card class="kpi-card kpi-valorisation">
      <mat-card-header>
        <mat-icon>attach_money</mat-icon>
        <mat-card-title>Valorisation (Revenus)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="kpi-value success">+ {{ kpis.budgetValorisation | number:'1.2-2' }} MAD</div>
        <div class="kpi-subtitle" *ngIf="kpis.evolutionValorisationPct">
          <span [class]="kpis.evolutionValorisationPct > 0 ? 'evolution-positive' : 'evolution-negative'">
            {{ kpis.evolutionValorisationPct > 0 ? '‚Üó' : '‚Üò' }} 
            {{ kpis.evolutionValorisationPct | number:'1.0-0' }}% vs p√©riode pr√©c√©dente
          </span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- KPI 5 : Budget traitement -->
    <mat-card class="kpi-card kpi-traitement">
      <mat-card-header>
        <mat-icon>warning</mat-icon>
        <mat-card-title>Traitement (Co√ªts)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="kpi-value danger">- {{ kpis.budgetTraitement | number:'1.2-2' }} MAD</div>
        <div class="kpi-subtitle" *ngIf="kpis.evolutionTraitementPct">
          <span [class]="kpis.evolutionTraitementPct < 0 ? 'evolution-positive' : 'evolution-negative'">
            {{ kpis.evolutionTraitementPct < 0 ? '‚Üò' : '‚Üó' }} 
            {{ Math.abs(kpis.evolutionTraitementPct) | number:'1.0-0' }}%
            (‚Üì = bien)
          </span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Bilan Net -->
    <mat-card class="kpi-card kpi-bilan">
      <mat-card-header>
        <mat-icon>account_balance</mat-icon>
        <mat-card-title>Bilan Net</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="kpi-value primary" [class.success]="kpis.bilanNet > 0" [class.danger]="kpis.bilanNet < 0">
          {{ kpis.bilanNet > 0 ? '+' : '' }}{{ kpis.bilanNet | number:'1.2-2' }} MAD
        </div>
        <div class="kpi-subtitle">{{ kpis.bilanNet > 0 ? '‚úÖ Bilan positif' : '‚ö†Ô∏è Bilan n√©gatif' }}</div>
      </mat-card-content>
    </mat-card>

    <!-- Taux de valorisation -->
    <mat-card class="kpi-card kpi-taux">
      <mat-card-header>
        <mat-icon>eco</mat-icon>
        <mat-card-title>Taux de valorisation</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="kpi-value" [class]="getTauxClass(kpis.tauxValorisation)">
          {{ kpis.tauxValorisation | number:'1.1-1' }} %
        </div>
        <div class="kpi-subtitle">{{ getTauxLabel(kpis.tauxValorisation) }}</div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- KPI 2 : Quantit√©s par type (graphique) -->
  <mat-card class="chart-card" *ngIf="kpis && !loading">
    <mat-card-header>
      <mat-card-title>üìä R√©partition des d√©chets</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="chart-grid">
        <!-- Graphique camembert -->
        <div class="chart-container">
          <canvas id="pieChart"></canvas>
        </div>

        <!-- D√©tails textuels -->
        <div class="quantites-details">
          <div class="detail-row valorisable">
            <span class="label">üîÑ VALORISABLE</span>
            <span class="value">{{ kpis.quantites.valorisable | number:'1.3-3' }} kg</span>
            <span class="percentage">({{ kpis.quantites.pourcentageValorisable | number:'1.1-1' }}%)</span>
          </div>
          <div class="detail-row banal">
            <span class="label">üóëÔ∏è BANAL</span>
            <span class="value">{{ kpis.quantites.banal | number:'1.3-3' }} kg</span>
            <span class="percentage">({{ kpis.quantites.pourcentageBanal | number:'1.1-1' }}%)</span>
          </div>
          <div class="detail-row a-eliminer">
            <span class="label">‚ò£Ô∏è A ELIMINER</span>
            <span class="value">{{ kpis.quantites.aEliminer | number:'1.3-3' }} kg</span>
            <span class="percentage">({{ kpis.quantites.pourcentageAEliminer | number:'1.1-1' }}%)</span>
          </div>
          <div class="detail-row total">
            <span class="label"><strong>üì¶ TOTAL</strong></span>
            <span class="value"><strong>{{ kpis.quantites.total | number:'1.3-3' }} kg</strong></span>
            <span class="percentage"><strong>(100%)</strong></span>
          </div>

          <!-- D√©tail par sous-type pour VALORISABLE -->
          <div class="sous-types-detail" *ngIf="kpis.quantites.detailValorisable && Object.keys(kpis.quantites.detailValorisable).length > 0">
            <h4>D√©tail VALORISABLE par mat√©riau</h4>
            <div class="sous-type-row" *ngFor="let sousType of Object.keys(kpis.quantites.detailValorisable)">
              <span>{{ sousType }}</span>
              <span>{{ kpis.quantites.detailValorisable[sousType] | number:'1.3-3' }} kg</span>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
