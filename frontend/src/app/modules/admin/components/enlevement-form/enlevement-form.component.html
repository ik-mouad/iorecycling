<div class="enlevement-form-container">
  <!-- Header Premium -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">{{ 'enlevement.createTitle' | translate }}</h1>
        <p class="page-description">{{ 'enlevement.createDescription' | translate }}</p>
      </div>
    </div>
  </div>

  <!-- Stepper Premium -->
  <div class="stepper-wrapper">
    <mat-stepper linear #stepper>
      <!-- √âTAPE 1 : Informations g√©n√©rales -->
      <mat-step [stepControl]="step1Form" [label]="'enlevement.step1Label' | translate">
        <form [formGroup]="step1Form">
          <div class="form-card">
            <!-- Date -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'enlevement.dateEnlevement' | translate }}</mat-label>
              <input matInput [matDatepicker]="picker" formControlName="dateEnlevement">
              <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>

            <!-- Heure d'enl√®vement -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'enlevement.heureEnlevement' | translate }}</mat-label>
              <input matInput type="time" formControlName="heureEnlevement" placeholder="HH:mm">
              <mat-hint>{{ 'enlevement.heureFormat' | translate }}</mat-hint>
            </mat-form-field>

            <!-- Soci√©t√© -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'enlevement.societe' | translate }}</mat-label>
              <mat-select formControlName="societeId" [disabled]="societePredefinie !== null">
                <mat-option *ngFor="let societe of societes" [value]="societe.id">
                  {{ societe.raisonSociale }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Site -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'enlevement.site' | translate }}</mat-label>
              <mat-select
                formControlName="siteId"
                [disabled]="!step1Form.value.societeId || sitesLoading">
                <mat-option *ngIf="sitesLoading" disabled>
                  {{ 'enlevement.loadingSites' | translate }}
                </mat-option>
                <mat-option *ngFor="let site of sites" [value]="site.id">
                  {{ site.name }}
                </mat-option>
                <mat-option *ngIf="!sitesLoading && step1Form.value.societeId && sites.length === 0" disabled>
                  {{ 'enlevement.noSitesAvailable' | translate }}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="!step1Form.value.societeId">{{ 'enlevement.selectSocieteFirst' | translate }}</mat-hint>
            </mat-form-field>

            <!-- Observation -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'enlevement.observation' | translate }}</mat-label>
              <textarea matInput formControlName="observation" rows="3" 
                placeholder="Commentaires, remarques sur la collecte..."></textarea>
            </mat-form-field>

            <!-- Camion utilis√© -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'enlevement.camionUtilise' | translate }}</mat-label>
              <mat-select formControlName="camionId">
                <mat-option [value]="null">{{ 'enlevement.noCamion' | translate }}</mat-option>
                <mat-option *ngIf="camionsLoading" disabled>
                  {{ 'enlevement.loadingCamions' | translate }}
                </mat-option>
                <mat-option *ngFor="let camion of camions" [value]="camion.id">
                  {{ camion.matricule }} - {{ camion.typeCamion }} ({{ camion.tonnageMaxKg | number:'1.0-0' }} kg)
                </mat-option>
              </mat-select>
              <mat-hint>{{ 'enlevement.onlyActiveCamions' | translate }}</mat-hint>
            </mat-form-field>

            <!-- Chauffeur -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'enlevement.chauffeurNom' | translate }}</mat-label>
              <input matInput formControlName="chauffeurNom" placeholder="Ex: Mohamed BENALI">
            </mat-form-field>

            <!-- Destination -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'enlevement.destination' | translate }} {{ hasDechetsDangereux ? '*' : '' }}</mat-label>
              <mat-select formControlName="destinationId">
                <mat-option [value]="null">{{ 'enlevement.noDestination' | translate }}</mat-option>
                <mat-option *ngIf="destinationsLoading" disabled>
                  {{ 'enlevement.loadingDestinations' | translate }}
                </mat-option>
                <mat-option *ngFor="let destination of destinations" [value]="destination.id">
                  {{ destination.raisonSociale }} - {{ destination.site }}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="hasDechetsDangereux">
                {{ 'enlevement.destinationRequired' | translate }}
              </mat-hint>
              <mat-hint *ngIf="!hasDechetsDangereux">
                {{ 'enlevement.destinationOptional' | translate }}
              </mat-hint>
            </mat-form-field>

            <!-- Date de destination -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'enlevement.dateDestination' | translate }}</mat-label>
              <input matInput [matDatepicker]="pickerDestination" formControlName="dateDestination">
              <mat-datepicker-toggle matIconSuffix [for]="pickerDestination"></mat-datepicker-toggle>
              <mat-datepicker #pickerDestination></mat-datepicker>
              <mat-hint>{{ 'common.optional' | translate }}</mat-hint>
            </mat-form-field>

            <!-- Heure de destination -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'enlevement.heureDestination' | translate }}</mat-label>
              <input matInput type="time" formControlName="heureDestination" placeholder="HH:mm">
              <mat-hint>{{ 'enlevement.heureFormat' | translate }}</mat-hint>
            </mat-form-field>

            <!-- Warning tonnage -->
            <div *ngIf="tonnageMaxCamion && poidsTotal > tonnageMaxCamion" class="tonnage-warning">
              <mat-icon color="warn">warning</mat-icon>
              <span>
                {{ 'enlevement.tonnageWarning' | translate: { total: getFormattedPoidsTotal(), max: getFormattedTonnageMax() } }}
              </span>
            </div>
          </div>

          <div class="step-actions">
            <button mat-button (click)="cancel()" class="cancel-button">{{ 'common.cancel' | translate }}</button>
            <button mat-raised-button color="primary" matStepperNext [disabled]="step1Form.invalid" class="next-button">
              {{ 'common.next' | translate }}
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- √âTAPE 2 : Items (lignes de d√©tail) -->
      <mat-step [stepControl]="step2Form" [label]="'enlevement.step2Label' | translate">
        <form [formGroup]="step2Form">
          <div formArrayName="items">
            <div *ngFor="let item of itemsFormArray.controls; let i = index" [formGroupName]="i" class="item-card">
              <div class="item-header">
                <h3 class="item-title">{{ 'enlevement.item' | translate }} {{ i + 1 }}</h3>
                <button mat-icon-button color="warn" (click)="removeItem(i)" *ngIf="itemsFormArray.length > 1" class="delete-item-btn">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
              <div class="item-content">
                <!-- Premi√®re ligne : Type de d√©chet -->
                <div class="item-row-first">
                  <mat-form-field appearance="outline" class="field-type">
                    <mat-label>{{ 'enlevement.typeDechet' | translate }}</mat-label>
                    <mat-select formControlName="typeDechet">
                      <mat-option value="RECYCLABLE">{{ 'enlevement.typeRecyclable' | translate }}</mat-option>
                      <mat-option value="BANAL">{{ 'enlevement.typeBanal' | translate }}</mat-option>
                      <mat-option value="A_DETRUIRE">{{ 'enlevement.typeADetruire' | translate }}</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <!-- Deuxi√®me ligne : Sous-type, Quantit√©, Unit√©, √âtat, Prix, Montant -->
                <div class="item-row">
                  <!-- Sous-type (si RECYCLABLE) -->
                  <mat-form-field appearance="outline" class="field-sous-type" *ngIf="item.value.typeDechet === 'RECYCLABLE'">
                    <mat-label>{{ 'enlevement.sousType' | translate }} *</mat-label>
                    <mat-select formControlName="sousType">
                      <mat-option value="CARTON">Carton</mat-option>
                      <mat-option value="PLASTIQUE_PET">Plastique PET</mat-option>
                      <mat-option value="PLASTIQUE_PEHD">Plastique PEHD</mat-option>
                      <mat-option value="ALUMINIUM">Aluminium</mat-option>
                      <mat-option value="FER">Fer</mat-option>
                      <mat-option value="CUIVRE">Cuivre</mat-option>
                      <mat-option value="PAPIER">Papier</mat-option>
                      <mat-option value="VERRE">Verre</mat-option>
                    </mat-select>
                    <mat-error>{{ 'enlevement.sousTypeRequired' | translate }}</mat-error>
                  </mat-form-field>

                  <!-- Sous-type (si A_DETRUIRE) -->
                  <mat-form-field appearance="outline" class="field-sous-type" *ngIf="item.value.typeDechet === 'A_DETRUIRE'">
                    <mat-label>{{ 'enlevement.sousType' | translate }} *</mat-label>
                    <mat-select formControlName="sousType">
                      <mat-option value="DANGEREUX">Dangereux</mat-option>
                      <mat-option value="NON_DANGEREUX">Non dangereux</mat-option>
                    </mat-select>
                    <mat-error>{{ 'enlevement.sousTypeRequiredADetruire' | translate }}</mat-error>
                  </mat-form-field>

                  <!-- Espace vide si pas de sous-type -->
                  <div class="field-sous-type-empty" *ngIf="item.value.typeDechet !== 'RECYCLABLE' && item.value.typeDechet !== 'A_DETRUIRE'"></div>

                  <!-- Quantit√© -->
                  <mat-form-field appearance="outline" class="field-quantite">
                    <mat-label>{{ 'enlevement.quantite' | translate }}</mat-label>
                    <input matInput type="number" step="0.001" formControlName="quantiteKg">
                  </mat-form-field>

                  <!-- Unit√© de mesure -->
                  <mat-form-field appearance="outline" class="field-unite">
                    <mat-label>{{ 'enlevement.unite' | translate }}</mat-label>
                    <mat-select formControlName="uniteMesure">
                      <mat-option value="kg">kg</mat-option>
                      <mat-option value="L">L</mat-option>
                      <mat-option value="m¬≥">m¬≥</mat-option>
                      <mat-option value="unit√©">unit√©</mat-option>
                      <mat-option value="pi√®ce">pi√®ce</mat-option>
                      <mat-option value="palette">palette</mat-option>
                      <mat-option value="carton">carton</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <!-- √âtat -->
                  <mat-form-field appearance="outline" class="field-etat">
                    <mat-label>{{ 'enlevement.etat' | translate }}</mat-label>
                    <mat-select formControlName="etat">
                      <mat-option value="vrac">Vrac</mat-option>
                      <mat-option value="compact√©">Compact√©</mat-option>
                      <mat-option value="broy√©">Broy√©</mat-option>
                      <mat-option value="Palettis√©">Palettis√©</mat-option>
                      <mat-option value="autre">Autre</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <!-- Prix unitaire -->
                  <mat-form-field appearance="outline" class="field-prix">
                    <mat-label>{{ 'enlevement.prixUnitaire' | translate }}</mat-label>
                    <input matInput type="number" step="0.01" formControlName="prixUnitaireMad">
                    <mat-hint>{{ 'enlevement.prixPerUnite' | translate: { unite: (item.value.uniteMesure || 'kg') } }}</mat-hint>
                  </mat-form-field>

                  <!-- Section Financi√®re -->
                  <div class="financial-section" *ngIf="item.value.typeDechet">
                    <h4 class="financial-title">{{ 'enlevement.financialSection' | translate }}</h4>
                    
                    <!-- Prix prestation (tous types) -->
                    <mat-form-field appearance="outline" class="field-prix">
                      <mat-label>{{ 'enlevement.prixPrestation' | translate }}</mat-label>
                      <input matInput type="number" step="0.01" formControlName="prixPrestationMad">
                      <mat-hint>{{ 'enlevement.prestationHint' | translate }}</mat-hint>
                    </mat-form-field>

                    <!-- Prix achat (si valorisable) -->
                    <mat-form-field appearance="outline" class="field-prix" 
                        *ngIf="item.value.typeDechet === 'RECYCLABLE'">
                      <mat-label>{{ 'enlevement.prixAchat' | translate }}</mat-label>
                      <input matInput type="number" step="0.01" formControlName="prixAchatMad">
                      <mat-hint>{{ 'enlevement.achatHint' | translate }}</mat-hint>
                    </mat-form-field>

                    <!-- Prix traitement (si banal) -->
                    <mat-form-field appearance="outline" class="field-prix" 
                        *ngIf="item.value.typeDechet === 'BANAL' || item.value.typeDechet === 'A_DETRUIRE'">
                      <mat-label>{{ 'enlevement.prixTraitement' | translate }}</mat-label>
                      <input matInput type="number" step="0.01" formControlName="prixTraitementMad">
                      <mat-hint>{{ 'enlevement.traitementHint' | translate }}</mat-hint>
                    </mat-form-field>

                    <!-- Calculs automatiques -->
                    <div class="calculations">
                      <div *ngIf="item.value.typeDechet === 'RECYCLABLE'">
                        <p><strong>{{ 'enlevement.montantAchat' | translate }} :</strong> 
                          {{ calculateMontantAchat(item.value) | number:'1.2-2' }} MAD</p>
                      </div>
                      <div *ngIf="item.value.typeDechet === 'BANAL' || item.value.typeDechet === 'A_DETRUIRE'">
                        <p><strong>{{ 'enlevement.montantTraitement' | translate }} :</strong> 
                          {{ calculateMontantTraitement(item.value) | number:'1.2-2' }} MAD</p>
                      </div>
                      <p><strong>{{ 'enlevement.montantPrestation' | translate }} :</strong> 
                        {{ calculateMontantPrestation(item.value) | number:'1.2-2' }} MAD</p>
                    </div>
                  </div>

                  <!-- Montant calcul√© -->
                  <div class="field-montant">
                    <strong>{{ 'enlevement.montant' | translate }}</strong>
                    <div class="montant-value">
                      {{ calculateMontant(item.value) | number:'1.2-2' }} MAD
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <button mat-stroked-button color="primary" (click)="addItem()" class="add-item-btn">
            <mat-icon>add</mat-icon>
            {{ 'enlevement.addItem' | translate }}
          </button>

          <div class="step-actions">
            <button mat-button matStepperPrevious class="prev-button">
              <mat-icon>arrow_back</mat-icon>
              {{ 'common.previous' | translate }}
            </button>
            <button mat-raised-button color="primary" matStepperNext [disabled]="step2Form.invalid" class="next-button">
              {{ 'common.next' | translate }}
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- √âTAPE 3 : R√©capitulatif -->
      <mat-step [label]="'enlevement.step3Label' | translate">
        <div class="recap-card">
          <!-- Informations g√©n√©rales -->
          <div class="recap-section">
            <h3 class="recap-title">{{ 'enlevement.recapGeneralInfo' | translate }}</h3>
            <div class="recap-info">
              <div class="info-item">
                <span class="info-label">{{ 'enlevement.date' | translate }} :</span>
                <span class="info-value">{{ step1Form.value.dateEnlevement | date:'dd/MM/yyyy' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">{{ 'enlevement.societe' | translate }} :</span>
                <span class="info-value">{{ getSocieteNom(step1Form.value.societeId) }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">{{ 'enlevement.site' | translate }} :</span>
                <span class="info-value">{{ getSiteNom(step1Form.value.siteId) }}</span>
              </div>
              <div class="info-item" *ngIf="step1Form.value.observation">
                <span class="info-label">{{ 'enlevement.observation' | translate }} :</span>
                <span class="info-value">{{ step1Form.value.observation }}</span>
              </div>
              <div class="info-item" *ngIf="step1Form.value.camionId">
                <span class="info-label">{{ 'enlevement.camion' | translate }} :</span>
                <span class="info-value">
                  üöö {{ getCamionMatricule(step1Form.value.camionId) }}
                  <span *ngIf="step1Form.value.chauffeurNom"> - {{ 'enlevement.chauffeur' | translate }}: {{ step1Form.value.chauffeurNom }}</span>
                </span>
              </div>
              <div class="info-item" *ngIf="step1Form.value.destinationId">
                <span class="info-label">{{ 'enlevement.destination' | translate }} :</span>
                <span class="info-value">
                  üè≠ {{ getDestinationNom(step1Form.value.destinationId) }}
                </span>
              </div>
            </div>
          </div>

          <!-- Items -->
          <div class="recap-section">
            <h3 class="recap-title">{{ 'enlevement.recapWasteDetails' | translate }}</h3>
            <div class="recap-table-wrapper">
              <table class="recap-table">
                <thead>
                  <tr>
                    <th>{{ 'enlevement.type' | translate }}</th>
                    <th>{{ 'enlevement.sousType' | translate }}</th>
                    <th>{{ 'enlevement.quantite' | translate }}</th>
                    <th>{{ 'enlevement.etat' | translate }}</th>
                    <th>{{ 'enlevement.prixUnitaire' | translate }}</th>
                    <th>{{ 'enlevement.montant' | translate }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of itemsFormArray.value; let i = index" 
                      [class]="'type-' + item.typeDechet.toLowerCase()">
                    <td>{{ getTypeDechetLabel(item.typeDechet) }}</td>
                    <td>{{ item.sousType || '-' }}</td>
                    <td>{{ item.quantiteKg | number:'1.2-2' }} {{ item.uniteMesure || 'kg' }}</td>
                    <td>{{ item.etat || '-' }}</td>
                    <td>{{ item.prixUnitaireMad | number:'1.2-2' }} MAD / {{ item.uniteMesure || 'kg' }}</td>
                    <td><strong>{{ calculateMontant(item) | number:'1.2-2' }} MAD</strong></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Totaux -->
          <div class="recap-section recap-totaux">
            <h3 class="recap-title">{{ 'enlevement.recapFinancialTotals' | translate }}</h3>
            <div class="totaux-grid">
              <div class="totaux-item">
                <span class="totaux-label">{{ 'enlevement.poidsTotal' | translate }}</span>
                <strong class="totaux-value">{{ calculateTotaux().poidsTotal | number:'1.2-2' }} kg</strong>
              </div>
              <div class="totaux-item totaux-success">
                <span class="totaux-label">{{ 'enlevement.totalPrestation' | translate }}</span>
                <strong class="totaux-value">+ {{ calculateTotaux().totalPrestation | number:'1.2-2' }} MAD</strong>
              </div>
              <div class="totaux-item totaux-warning" *ngIf="calculateTotaux().totalAchat > 0">
                <span class="totaux-label">{{ 'enlevement.totalAchat' | translate }}</span>
                <strong class="totaux-value">- {{ calculateTotaux().totalAchat | number:'1.2-2' }} MAD</strong>
              </div>
              <div class="totaux-item totaux-danger" *ngIf="calculateTotaux().totalTraitement > 0">
                <span class="totaux-label">{{ 'enlevement.totalTraitement' | translate }}</span>
                <strong class="totaux-value">- {{ calculateTotaux().totalTraitement | number:'1.2-2' }} MAD</strong>
              </div>
              <div class="totaux-item totaux-primary">
                <span class="totaux-label">{{ 'enlevement.bilanNet' | translate }}</span>
                <strong class="totaux-value">{{ calculateTotaux().bilanNet > 0 ? '+' : '' }}{{ calculateTotaux().bilanNet | number:'1.2-2' }} MAD</strong>
              </div>
              <div class="totaux-item">
                <span class="totaux-label">{{ 'enlevement.tauxRecyclage' | translate }}</span>
                <strong class="totaux-value">{{ calculateTotaux().tauxRecyclage | number:'1.1-1' }} %</strong>
              </div>
            </div>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button matStepperPrevious [disabled]="loading" class="prev-button">
            <mat-icon>arrow_back</mat-icon>
            {{ 'common.previous' | translate }}
          </button>
          <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="loading" class="submit-button">
            <mat-spinner *ngIf="loading" diameter="20" class="button-spinner"></mat-spinner>
            <mat-icon *ngIf="!loading">check</mat-icon>
            <span>{{ loading ? ('enlevement.creating' | translate) : ('enlevement.createEnlevement' | translate) }}</span>
          </button>
        </div>
      </mat-step>
    </mat-stepper>
  </div>
</div>
