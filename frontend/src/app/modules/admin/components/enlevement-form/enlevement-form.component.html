<div class="enlevement-form-container">
  <!-- Header Premium -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">Cr√©er un enl√®vement</h1>
        <p class="page-description">Enregistrez un nouvel enl√®vement en 3 √©tapes simples</p>
      </div>
    </div>
  </div>

  <!-- Stepper Premium -->
  <div class="stepper-wrapper">
    <mat-stepper linear #stepper>
      <!-- √âTAPE 1 : Informations g√©n√©rales -->
      <mat-step [stepControl]="step1Form" label="Informations g√©n√©rales">
        <form [formGroup]="step1Form">
          <div class="form-card">
            <!-- Date -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Date de l'enl√®vement</mat-label>
              <input matInput [matDatepicker]="picker" formControlName="dateEnlevement">
              <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>

            <!-- Heure d'enl√®vement -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Heure d'enl√®vement</mat-label>
              <input matInput type="time" formControlName="heureEnlevement" placeholder="HH:mm">
              <mat-hint>Format: HH:mm (optionnel)</mat-hint>
            </mat-form-field>

            <!-- Soci√©t√© -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Soci√©t√©</mat-label>
              <mat-select formControlName="societeId" [disabled]="societePredefinie !== null">
                <mat-option *ngFor="let societe of societes" [value]="societe.id">
                  {{ societe.raisonSociale }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Site -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Site</mat-label>
              <mat-select
                formControlName="siteId"
                [disabled]="!step1Form.value.societeId || sitesLoading">
                <mat-option *ngIf="sitesLoading" disabled>
                  Chargement des sites...
                </mat-option>
                <mat-option *ngFor="let site of sites" [value]="site.id">
                  {{ site.name }}
                </mat-option>
                <mat-option *ngIf="!sitesLoading && step1Form.value.societeId && sites.length === 0" disabled>
                  Aucun site disponible pour cette soci√©t√©
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="!step1Form.value.societeId">S√©lectionnez d'abord une soci√©t√©</mat-hint>
            </mat-form-field>

            <!-- Observation -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Observation</mat-label>
              <textarea matInput formControlName="observation" rows="3" 
                placeholder="Commentaires, remarques sur la collecte..."></textarea>
            </mat-form-field>

            <!-- Camion utilis√© -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Camion utilis√©</mat-label>
              <mat-select formControlName="camionId">
                <mat-option [value]="null">Aucun camion</mat-option>
                <mat-option *ngIf="camionsLoading" disabled>
                  Chargement des camions...
                </mat-option>
                <mat-option *ngFor="let camion of camions" [value]="camion.id">
                  {{ camion.matricule }} - {{ camion.typeCamion }} ({{ camion.tonnageMaxKg | number:'1.0-0' }} kg)
                </mat-option>
              </mat-select>
              <mat-hint>Seuls les camions actifs sont disponibles</mat-hint>
            </mat-form-field>

            <!-- Chauffeur -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Nom du chauffeur</mat-label>
              <input matInput formControlName="chauffeurNom" placeholder="Ex: Mohamed BENALI">
            </mat-form-field>

            <!-- Destination -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Destination {{ hasDechetsDangereux ? '*' : '' }}</mat-label>
              <mat-select formControlName="destinationId">
                <mat-option [value]="null">Aucune destination</mat-option>
                <mat-option *ngIf="destinationsLoading" disabled>
                  Chargement des destinations...
                </mat-option>
                <mat-option *ngFor="let destination of destinations" [value]="destination.id">
                  {{ destination.raisonSociale }} - {{ destination.site }}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="hasDechetsDangereux">
                Obligatoire pour les d√©chets dangereux. Seules les destinations compatibles sont affich√©es.
              </mat-hint>
              <mat-hint *ngIf="!hasDechetsDangereux">
                Optionnel (obligatoire si des d√©chets dangereux sont pr√©sents)
              </mat-hint>
            </mat-form-field>

            <!-- Date de destination -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Date d'arriv√©e √† destination</mat-label>
              <input matInput [matDatepicker]="pickerDestination" formControlName="dateDestination">
              <mat-datepicker-toggle matIconSuffix [for]="pickerDestination"></mat-datepicker-toggle>
              <mat-datepicker #pickerDestination></mat-datepicker>
              <mat-hint>Optionnel</mat-hint>
            </mat-form-field>

            <!-- Heure de destination -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Heure d'arriv√©e √† destination</mat-label>
              <input matInput type="time" formControlName="heureDestination" placeholder="HH:mm">
              <mat-hint>Format: HH:mm (optionnel)</mat-hint>
            </mat-form-field>

            <!-- Warning tonnage -->
            <div *ngIf="tonnageMaxCamion && poidsTotal > tonnageMaxCamion" class="tonnage-warning">
              <mat-icon color="warn">warning</mat-icon>
              <span>
                Attention : Le poids total ({{ poidsTotal | number:'1.2-2' }} kg) d√©passe le tonnage maximum du camion s√©lectionn√© ({{ tonnageMaxCamion | number:'1.0-0' }} kg)
              </span>
            </div>
          </div>

          <div class="step-actions">
            <button mat-button (click)="cancel()" class="cancel-button">Annuler</button>
            <button mat-raised-button color="primary" matStepperNext [disabled]="step1Form.invalid" class="next-button">
              Suivant
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- √âTAPE 2 : Items (lignes de d√©tail) -->
      <mat-step [stepControl]="step2Form" label="D√©tails des d√©chets">
        <form [formGroup]="step2Form">
          <div formArrayName="items">
            <div *ngFor="let item of itemsFormArray.controls; let i = index" [formGroupName]="i" class="item-card">
              <div class="item-header">
                <h3 class="item-title">Item {{ i + 1 }}</h3>
                <button mat-icon-button color="warn" (click)="removeItem(i)" *ngIf="itemsFormArray.length > 1" class="delete-item-btn">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
              <div class="item-content">
                <!-- Premi√®re ligne : Type de d√©chet -->
                <div class="item-row-first">
                  <mat-form-field appearance="outline" class="field-type">
                    <mat-label>Type de d√©chet</mat-label>
                    <mat-select formControlName="typeDechet">
                      <mat-option value="RECYCLABLE">üîÑ Recyclable</mat-option>
                      <mat-option value="BANAL">üóëÔ∏è Banal (ordinaire)</mat-option>
                      <mat-option value="A_DETRUIRE">‚ò£Ô∏è A d√©truire</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <!-- Deuxi√®me ligne : Sous-type, Quantit√©, Unit√©, √âtat, Prix, Montant -->
                <div class="item-row">
                  <!-- Sous-type (si RECYCLABLE) -->
                  <mat-form-field appearance="outline" class="field-sous-type" *ngIf="item.value.typeDechet === 'RECYCLABLE'">
                    <mat-label>Sous-type *</mat-label>
                    <mat-select formControlName="sousType">
                      <mat-option value="CARTON">Carton</mat-option>
                      <mat-option value="PLASTIQUE_PET">Plastique PET</mat-option>
                      <mat-option value="PLASTIQUE_PEHD">Plastique PEHD</mat-option>
                      <mat-option value="ALUMINIUM">Aluminium</mat-option>
                      <mat-option value="FER">Fer</mat-option>
                      <mat-option value="CUIVRE">Cuivre</mat-option>
                      <mat-option value="PAPIER">Papier</mat-option>
                      <mat-option value="VERRE">Verre</mat-option>
                    </mat-select>
                    <mat-error>Obligatoire pour RECYCLABLE</mat-error>
                  </mat-form-field>

                  <!-- Sous-type (si A_DETRUIRE) -->
                  <mat-form-field appearance="outline" class="field-sous-type" *ngIf="item.value.typeDechet === 'A_DETRUIRE'">
                    <mat-label>Sous-type *</mat-label>
                    <mat-select formControlName="sousType">
                      <mat-option value="DANGEREUX">Dangereux</mat-option>
                      <mat-option value="NON_DANGEREUX">Non dangereux</mat-option>
                    </mat-select>
                    <mat-error>Obligatoire pour A d√©truire</mat-error>
                  </mat-form-field>

                  <!-- Espace vide si pas de sous-type -->
                  <div class="field-sous-type-empty" *ngIf="item.value.typeDechet !== 'RECYCLABLE' && item.value.typeDechet !== 'A_DETRUIRE'"></div>

                  <!-- Quantit√© -->
                  <mat-form-field appearance="outline" class="field-quantite">
                    <mat-label>Quantit√©</mat-label>
                    <input matInput type="number" step="0.001" formControlName="quantiteKg">
                  </mat-form-field>

                  <!-- Unit√© de mesure -->
                  <mat-form-field appearance="outline" class="field-unite">
                    <mat-label>Unit√©</mat-label>
                    <mat-select formControlName="uniteMesure">
                      <mat-option value="kg">kg</mat-option>
                      <mat-option value="L">L</mat-option>
                      <mat-option value="m¬≥">m¬≥</mat-option>
                      <mat-option value="unit√©">unit√©</mat-option>
                      <mat-option value="pi√®ce">pi√®ce</mat-option>
                      <mat-option value="palette">palette</mat-option>
                      <mat-option value="carton">carton</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <!-- √âtat -->
                  <mat-form-field appearance="outline" class="field-etat">
                    <mat-label>√âtat</mat-label>
                    <mat-select formControlName="etat">
                      <mat-option value="vrac">Vrac</mat-option>
                      <mat-option value="compact√©">Compact√©</mat-option>
                      <mat-option value="broy√©">Broy√©</mat-option>
                      <mat-option value="Palettis√©">Palettis√©</mat-option>
                      <mat-option value="autre">Autre</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <!-- Prix unitaire -->
                  <mat-form-field appearance="outline" class="field-prix">
                    <mat-label>Prix unitaire (MAD)</mat-label>
                    <input matInput type="number" step="0.01" formControlName="prixUnitaireMad">
                    <mat-hint>Prix par {{ item.value.uniteMesure || 'kg' }}</mat-hint>
                  </mat-form-field>

                  <!-- Section Financi√®re -->
                  <div class="financial-section" *ngIf="item.value.typeDechet">
                    <h4 class="financial-title">üí∞ Financier</h4>
                    
                    <!-- Prix prestation (tous types) -->
                    <mat-form-field appearance="outline" class="field-prix">
                      <mat-label>Prix prestation (MAD/kg)</mat-label>
                      <input matInput type="number" step="0.01" formControlName="prixPrestationMad">
                      <mat-hint>Prestation d'enl√®vement</mat-hint>
                    </mat-form-field>

                    <!-- Prix achat (si valorisable) -->
                    <mat-form-field appearance="outline" class="field-prix" 
                        *ngIf="item.value.typeDechet === 'RECYCLABLE'">
                      <mat-label>Prix achat (MAD/kg)</mat-label>
                      <input matInput type="number" step="0.01" formControlName="prixAchatMad">
                      <mat-hint>Ce que l'entreprise paie au client</mat-hint>
                    </mat-form-field>

                    <!-- Prix traitement (si banal) -->
                    <mat-form-field appearance="outline" class="field-prix" 
                        *ngIf="item.value.typeDechet === 'BANAL' || item.value.typeDechet === 'A_DETRUIRE'">
                      <mat-label>Prix traitement (MAD/kg)</mat-label>
                      <input matInput type="number" step="0.01" formControlName="prixTraitementMad">
                      <mat-hint>Co√ªt de traitement</mat-hint>
                    </mat-form-field>

                    <!-- Calculs automatiques -->
                    <div class="calculations">
                      <div *ngIf="item.value.typeDechet === 'RECYCLABLE'">
                        <p><strong>Montant achat :</strong> 
                          {{ calculateMontantAchat(item.value) | number:'1.2-2' }} MAD</p>
                      </div>
                      <div *ngIf="item.value.typeDechet === 'BANAL' || item.value.typeDechet === 'A_DETRUIRE'">
                        <p><strong>Montant traitement :</strong> 
                          {{ calculateMontantTraitement(item.value) | number:'1.2-2' }} MAD</p>
                      </div>
                      <p><strong>Montant prestation :</strong> 
                        {{ calculateMontantPrestation(item.value) | number:'1.2-2' }} MAD</p>
                    </div>
                  </div>

                  <!-- Montant calcul√© -->
                  <div class="field-montant">
                    <strong>Montant</strong>
                    <div class="montant-value">
                      {{ calculateMontant(item.value) | number:'1.2-2' }} MAD
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <button mat-stroked-button color="primary" (click)="addItem()" class="add-item-btn">
            <mat-icon>add</mat-icon>
            Ajouter un item
          </button>

          <div class="step-actions">
            <button mat-button matStepperPrevious class="prev-button">
              <mat-icon>arrow_back</mat-icon>
              Pr√©c√©dent
            </button>
            <button mat-raised-button color="primary" matStepperNext [disabled]="step2Form.invalid" class="next-button">
              Suivant
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- √âTAPE 3 : R√©capitulatif -->
      <mat-step label="R√©capitulatif">
        <div class="recap-card">
          <!-- Informations g√©n√©rales -->
          <div class="recap-section">
            <h3 class="recap-title">üìã Informations g√©n√©rales</h3>
            <div class="recap-info">
              <div class="info-item">
                <span class="info-label">Date :</span>
                <span class="info-value">{{ step1Form.value.dateEnlevement | date:'dd/MM/yyyy' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Soci√©t√© :</span>
                <span class="info-value">{{ getSocieteNom(step1Form.value.societeId) }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Site :</span>
                <span class="info-value">{{ getSiteNom(step1Form.value.siteId) }}</span>
              </div>
              <div class="info-item" *ngIf="step1Form.value.observation">
                <span class="info-label">Observation :</span>
                <span class="info-value">{{ step1Form.value.observation }}</span>
              </div>
              <div class="info-item" *ngIf="step1Form.value.camionId">
                <span class="info-label">Camion :</span>
                <span class="info-value">
                  üöö {{ getCamionMatricule(step1Form.value.camionId) }}
                  <span *ngIf="step1Form.value.chauffeurNom"> - Chauffeur: {{ step1Form.value.chauffeurNom }}</span>
                </span>
              </div>
              <div class="info-item" *ngIf="step1Form.value.destinationId">
                <span class="info-label">Destination :</span>
                <span class="info-value">
                  üè≠ {{ getDestinationNom(step1Form.value.destinationId) }}
                </span>
              </div>
            </div>
          </div>

          <!-- Items -->
          <div class="recap-section">
            <h3 class="recap-title">üì¶ D√©tails des d√©chets</h3>
            <div class="recap-table-wrapper">
              <table class="recap-table">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Sous-type</th>
                    <th>Quantit√©</th>
                    <th>√âtat</th>
                    <th>Prix unitaire</th>
                    <th>Montant</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of itemsFormArray.value; let i = index" 
                      [class]="'type-' + item.typeDechet.toLowerCase()">
                    <td>{{ getTypeDechetLabel(item.typeDechet) }}</td>
                    <td>{{ item.sousType || '-' }}</td>
                    <td>{{ item.quantiteKg | number:'1.3-3' }} {{ item.uniteMesure || 'kg' }}</td>
                    <td>{{ item.etat || '-' }}</td>
                    <td>{{ item.prixUnitaireMad | number:'1.2-2' }} MAD / {{ item.uniteMesure || 'kg' }}</td>
                    <td><strong>{{ calculateMontant(item) | number:'1.2-2' }} MAD</strong></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Totaux -->
          <div class="recap-section recap-totaux">
            <h3 class="recap-title">üí∞ Totaux financiers</h3>
            <div class="totaux-grid">
              <div class="totaux-item">
                <span class="totaux-label">Poids total</span>
                <strong class="totaux-value">{{ calculateTotaux().poidsTotal | number:'1.3-3' }} kg</strong>
              </div>
              <div class="totaux-item totaux-success">
                <span class="totaux-label">Total prestation</span>
                <strong class="totaux-value">+ {{ calculateTotaux().totalPrestation | number:'1.2-2' }} MAD</strong>
              </div>
              <div class="totaux-item totaux-warning" *ngIf="calculateTotaux().totalAchat > 0">
                <span class="totaux-label">Total achat</span>
                <strong class="totaux-value">- {{ calculateTotaux().totalAchat | number:'1.2-2' }} MAD</strong>
              </div>
              <div class="totaux-item totaux-danger" *ngIf="calculateTotaux().totalTraitement > 0">
                <span class="totaux-label">Total traitement</span>
                <strong class="totaux-value">- {{ calculateTotaux().totalTraitement | number:'1.2-2' }} MAD</strong>
              </div>
              <div class="totaux-item totaux-primary">
                <span class="totaux-label">Bilan net</span>
                <strong class="totaux-value">{{ calculateTotaux().bilanNet > 0 ? '+' : '' }}{{ calculateTotaux().bilanNet | number:'1.2-2' }} MAD</strong>
              </div>
              <div class="totaux-item">
                <span class="totaux-label">Taux de recyclage</span>
                <strong class="totaux-value">{{ calculateTotaux().tauxRecyclage | number:'1.1-1' }} %</strong>
              </div>
            </div>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button matStepperPrevious [disabled]="loading" class="prev-button">
            <mat-icon>arrow_back</mat-icon>
            Pr√©c√©dent
          </button>
          <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="loading" class="submit-button">
            <mat-spinner *ngIf="loading" diameter="20" class="button-spinner"></mat-spinner>
            <mat-icon *ngIf="!loading">check</mat-icon>
            <span>{{ loading ? 'Cr√©ation en cours...' : 'Cr√©er l\'enl√®vement' }}</span>
          </button>
        </div>
      </mat-step>
    </mat-stepper>
  </div>
</div>
