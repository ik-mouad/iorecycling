<div class="transaction-form">
  <!-- MODE CONSULTATION : Vue dÃ©diÃ©e pour les dÃ©tails -->
  <div *ngIf="isViewMode && currentTransaction" class="transaction-detail-view">
    <!-- Header avec informations principales -->
    <div class="detail-header">
      <div class="header-left">
        <h1>ðŸ’° DÃ©tail de la Transaction</h1>
        <div class="transaction-meta">
          <mat-chip [class]="'statut-' + currentTransaction.statut.toLowerCase()">
            {{ getStatutLabel(currentTransaction.statut) }}
          </mat-chip>
          <mat-chip [class]="currentTransaction.type === TypeTransaction.RECETTE ? 'chip-recette' : 'chip-depense'">
            {{ getTypeLabel(currentTransaction.type) }}
          </mat-chip>
        </div>
      </div>
      <div class="header-actions">
        <button mat-stroked-button (click)="editTransaction()" *ngIf="basePath.startsWith('/admin')">
          <mat-icon>edit</mat-icon>
          Modifier
        </button>
        <button mat-stroked-button (click)="cancel()">
          <mat-icon>arrow_back</mat-icon>
          Retour Ã  la liste
        </button>
      </div>
    </div>

    <!-- Informations gÃ©nÃ©rales -->
    <mat-card class="info-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>info</mat-icon>
          {{ 'transaction.generalInfo' | translate }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">{{ 'transaction.type' | translate }} :</span>
            <span class="info-value">
              <mat-chip [class]="currentTransaction.type === TypeTransaction.RECETTE ? 'chip-recette' : 'chip-depense'">
                {{ getTypeLabel(currentTransaction.type) }}
              </mat-chip>
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">{{ 'transaction.montant' | translate }} :</span>
            <span class="info-value amount-value" [class.amount-recette]="currentTransaction.type === TypeTransaction.RECETTE" [class.amount-depense]="currentTransaction.type === TypeTransaction.DEPENSE">
              {{ currentTransaction.type === TypeTransaction.RECETTE ? '+' : '-' }}{{ currentTransaction.montant | number:'1.2-2' }} <span class="currency">MAD</span>
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">{{ 'transaction.dateTransaction' | translate }} :</span>
            <span class="info-value">{{ formatDate(currentTransaction.dateTransaction) }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">{{ 'transaction.statut' | translate }} :</span>
            <span class="info-value">
              <mat-chip [class]="'statut-' + currentTransaction.statut.toLowerCase()">
                {{ getStatutLabel(currentTransaction.statut) }}
              </mat-chip>
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">{{ 'transaction.description' | translate }} :</span>
            <span class="info-value">{{ currentTransaction.description }}</span>
          </div>
          <div class="info-item" *ngIf="currentTransaction.categorie">
            <span class="info-label">{{ 'transaction.categorie' | translate }} :</span>
            <span class="info-value">{{ currentTransaction.categorie }}</span>
          </div>
          <div class="info-item" *ngIf="currentTransaction.numeroReference">
            <span class="info-label">{{ 'transaction.numeroReference' | translate }} :</span>
            <span class="info-value">{{ currentTransaction.numeroReference }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">{{ 'transaction.societe' | translate }} :</span>
            <span class="info-value">{{ getSocieteName(currentTransaction.societeId) }}</span>
          </div>
          <div class="info-item" *ngIf="currentTransaction.enlevementNumero">
            <span class="info-label">{{ 'transaction.enlevement' | translate }} :</span>
            <span class="info-value">
              <button mat-button color="primary" (click)="viewEnlevement(currentTransaction.enlevementId!)">
                <mat-icon>local_shipping</mat-icon>
                {{ currentTransaction.enlevementNumero }}
              </button>
            </span>
          </div>
          <div class="info-item" *ngIf="currentTransaction.notes">
            <span class="info-label">{{ 'transaction.notes' | translate }} :</span>
            <span class="info-value">{{ currentTransaction.notes }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Informations financiÃ¨res -->
    <mat-card class="financial-card" *ngIf="currentTransaction.montantPaye !== undefined || currentTransaction.montantRestant !== undefined">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>account_balance</mat-icon>
          {{ 'transaction.financialInfo' | translate }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="financial-grid">
          <div class="financial-item">
            <span class="financial-label">{{ 'transaction.montantTotal' | translate }} :</span>
            <span class="financial-value">{{ currentTransaction.montant | number:'1.2-2' }} MAD</span>
          </div>
          <div class="financial-item" *ngIf="currentTransaction.montantPaye !== undefined">
            <span class="financial-label">{{ 'transaction.montantPaye' | translate }} :</span>
            <span class="financial-value paid-value">{{ currentTransaction.montantPaye | number:'1.2-2' }} MAD</span>
          </div>
          <div class="financial-item" *ngIf="currentTransaction.montantRestant !== undefined">
            <span class="financial-label">{{ 'transaction.montantRestant' | translate }} :</span>
            <span class="financial-value remaining-value">{{ currentTransaction.montantRestant | number:'1.2-2' }} MAD</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Paiements -->
    <mat-card class="paiements-card" *ngIf="isViewMode && currentTransaction">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>payment</mat-icon>
          {{ 'transaction.paiements' | translate }} ({{ currentTransaction.paiements?.length || 0 }})
        </mat-card-title>
        <div class="spacer"></div>
        <button 
          *ngIf="isComptable && currentTransaction.montantRestant && currentTransaction.montantRestant > 0"
          mat-raised-button 
          color="primary" 
          (click)="openAddPaiementDialog()">
          <mat-icon>add</mat-icon>
          {{ 'transaction.addPaiement' | translate }}
        </button>
      </mat-card-header>
      <mat-card-content>
        <div class="paiements-table-wrapper" *ngIf="currentTransaction.paiements && currentTransaction.paiements.length > 0">
          <table class="paiements-table">
            <thead>
              <tr>
                <th>{{ 'transaction.datePaiement' | translate }}</th>
                <th>{{ 'transaction.montant' | translate }}</th>
                <th>{{ 'transaction.modePaiement' | translate }}</th>
                <th>{{ 'transaction.reference' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let paiement of currentTransaction.paiements">
                <td>{{ formatDate(paiement.datePaiement) }}</td>
                <td class="amount-cell">{{ paiement.montant | number:'1.2-2' }} MAD</td>
                <td>{{ paiement.modePaiement }}</td>
                <td>{{ paiement.reference || '-' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div *ngIf="!currentTransaction.paiements || currentTransaction.paiements.length === 0" class="empty-state">
          <p>{{ 'transaction.noPaiements' | translate }}</p>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Ã‰chÃ©ances -->
    <mat-card class="echeances-card" *ngIf="currentTransaction.echeances && currentTransaction.echeances.length > 0">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>schedule</mat-icon>
          {{ 'transaction.echeances' | translate }} ({{ currentTransaction.echeances.length }})
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="echeances-table-wrapper">
          <table class="echeances-table">
            <thead>
              <tr>
                <th>{{ 'transaction.dateEcheance' | translate }}</th>
                <th>{{ 'transaction.montant' | translate }}</th>
                <th>{{ 'transaction.statut' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let echeance of currentTransaction.echeances">
                <td>{{ formatDate(echeance.dateEcheance) }}</td>
                <td class="amount-cell">{{ echeance.montant | number:'1.2-2' }} MAD</td>
                <td>
                  <mat-chip [class]="'statut-' + echeance.statut.toLowerCase()">
                    {{ getStatutLabel(echeance.statut) }}
                  </mat-chip>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- MÃ©tadonnÃ©es -->
    <mat-card class="metadata-card" *ngIf="currentTransaction.createdBy || currentTransaction.createdAt">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>history</mat-icon>
          {{ 'transaction.systemInfo' | translate }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="metadata-grid">
          <div class="info-item" *ngIf="currentTransaction.createdBy">
            <span class="info-label">{{ 'transaction.createdBy' | translate }} :</span>
            <span class="info-value">{{ currentTransaction.createdBy }}</span>
          </div>
          <div class="info-item" *ngIf="currentTransaction.createdAt">
            <span class="info-label">{{ 'transaction.createdAt' | translate }} :</span>
            <span class="info-value">{{ formatDateTime(currentTransaction.createdAt) }}</span>
          </div>
          <div class="info-item" *ngIf="currentTransaction.updatedAt">
            <span class="info-label">{{ 'transaction.updatedAt' | translate }} :</span>
            <span class="info-value">{{ formatDateTime(currentTransaction.updatedAt) }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- MODE CRÃ‰ATION/Ã‰DITION : Formulaire -->
  <div *ngIf="!isViewMode">
    <h1>{{ isEditMode ? ('transaction.edit' | translate) : ('transaction.new' | translate) }}</h1>

    <mat-card>
      <form [formGroup]="transactionForm" (ngSubmit)="onSubmit()">
        <div class="form-row">
          <mat-form-field>
            <mat-label>{{ 'transaction.type' | translate }}</mat-label>
            <mat-select formControlName="type" [disabled]="isEditMode || typeFixe">
              <mat-option value="RECETTE">{{ 'transaction.recette' | translate }}</mat-option>
              <mat-option value="DEPENSE">{{ 'transaction.depense' | translate }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field>
            <mat-label>{{ 'transaction.montantMAD' | translate }}</mat-label>
            <input matInput type="number" formControlName="montant" step="0.01" min="0.01">
            <mat-error *ngIf="transactionForm.get('montant')?.hasError('required')">
              {{ 'transaction.montantRequired' | translate }}
            </mat-error>
            <mat-error *ngIf="transactionForm.get('montant')?.hasError('min')">
              {{ 'transaction.montantMin' | translate }}
            </mat-error>
          </mat-form-field>

          <mat-form-field>
            <mat-label>{{ 'transaction.date' | translate }}</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="dateTransaction">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
        </div>

        <mat-form-field class="full-width">
          <mat-label>{{ 'transaction.description' | translate }} *</mat-label>
          <textarea matInput formControlName="description" rows="3"></textarea>
          <mat-error *ngIf="transactionForm.get('description')?.hasError('required')">
            {{ 'transaction.descriptionRequired' | translate }}
          </mat-error>
        </mat-form-field>

        <div class="form-row">
          <mat-form-field>
            <mat-label>{{ 'transaction.categorie' | translate }}</mat-label>
            <input matInput formControlName="categorie" placeholder="Ex: Frais gÃ©nÃ©raux, Facturation client...">
          </mat-form-field>

          <mat-form-field>
            <mat-label>{{ 'transaction.numeroReference' | translate }}</mat-label>
            <input matInput formControlName="numeroReference" placeholder="Ex: FACT-2024-001">
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field>
            <mat-label>{{ 'transaction.societe' | translate }} *</mat-label>
            <mat-select formControlName="societeId" (selectionChange)="onSocieteChange($event.value)">
              <mat-option *ngFor="let societe of societes" [value]="societe.id">
                {{ societe.raisonSociale }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="transactionForm.get('societeId')?.hasError('required')">
              {{ 'transaction.societeRequired' | translate }}
            </mat-error>
          </mat-form-field>

          <mat-form-field>
            <mat-label>{{ 'transaction.enlevement' | translate }} ({{ 'common.optional' | translate }})</mat-label>
            <mat-select formControlName="enlevementId">
              <mat-option [value]="null">{{ 'transaction.none' | translate }}</mat-option>
              <mat-option *ngFor="let enlevement of enlevements" [value]="enlevement.id">
                {{ enlevement.numeroEnlevement }} - {{ enlevement.dateEnlevement | date:'dd/MM/yyyy' }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <mat-form-field class="full-width">
          <mat-label>{{ 'transaction.notes' | translate }}</mat-label>
          <textarea matInput formControlName="notes" rows="3"></textarea>
        </mat-form-field>

        <!-- Ã‰chÃ©ances -->
        <div class="echeances-section">
          <mat-checkbox formControlName="hasEcheances">
            {{ 'transaction.hasEcheances' | translate }}
          </mat-checkbox>

          <div *ngIf="transactionForm.get('hasEcheances')?.value" class="echeances-list">
            <div *ngFor="let echeance of echeancesFormArray.controls; let i = index" class="echeance-item">
              <div class="form-row">
                <mat-form-field>
                  <mat-label>{{ 'transaction.montantEcheance' | translate }}</mat-label>
                  <input matInput type="number" [formControl]="$any(echeance.get('montant'))" step="0.01" min="0.01">
                </mat-form-field>

                <mat-form-field>
                  <mat-label>{{ 'transaction.dateEcheance' | translate }}</mat-label>
                  <input matInput [matDatepicker]="echeancePicker" [formControl]="$any(echeance.get('dateEcheance'))">
                  <mat-datepicker-toggle matSuffix [for]="echeancePicker"></mat-datepicker-toggle>
                  <mat-datepicker #echeancePicker></mat-datepicker>
                </mat-form-field>

                <button mat-icon-button type="button" (click)="removeEcheance(i)" color="warn">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <button mat-button type="button" (click)="addEcheance()">
              <mat-icon>add</mat-icon>
              {{ 'transaction.addEcheance' | translate }}
            </button>
          </div>
        </div>

        <div class="form-actions">
          <button mat-button type="button" (click)="cancel()">{{ 'common.cancel' | translate }}</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="loading || transactionForm.invalid">
            <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
            <span *ngIf="!loading">{{ isEditMode ? ('common.edit' | translate) : ('common.create' | translate) }}</span>
          </button>
        </div>
      </form>
    </mat-card>
  </div>
</div>
