<div class="enlevement-detail-container" *ngIf="enlevement">
  <!-- Header Premium -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <button mat-icon-button (click)="backToList()" class="back-button">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="header-title-group">
          <h1 class="page-title">EnlÃ¨vement {{ enlevement.numeroEnlevement }}</h1>
          <p class="page-description">DÃ©tails complets de l'enlÃ¨vement et documents associÃ©s</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Informations gÃ©nÃ©rales -->
  <div class="info-card">
    <h2 class="card-title">ğŸ“‹ {{ 'transaction.generalInfo' | translate }}</h2>
    <div class="info-grid">
      <div class="info-item">
        <label class="info-label">{{ 'enlevement.numero' | translate }}</label>
        <div class="info-value">
          <span class="badge badge-ice">{{ enlevement.numeroEnlevement }}</span>
        </div>
      </div>
      <div class="info-item">
        <label class="info-label">{{ 'enlevement.date' | translate }}</label>
        <div class="info-value">{{ enlevement.dateEnlevement | date:'dd/MM/yyyy' }}</div>
      </div>
      <div class="info-item" *ngIf="enlevement.heureEnlevement">
        <label class="info-label">{{ 'enlevement.heure' | translate }}</label>
        <div class="info-value">ğŸ• {{ formatTime(enlevement.heureEnlevement) }}</div>
      </div>
      <div class="info-item">
        <label class="info-label">{{ 'enlevement.societe' | translate }}</label>
        <div class="info-value">{{ enlevement.societeNom }}</div>
      </div>
      <div class="info-item">
        <label class="info-label">{{ 'enlevement.site' | translate }}</label>
        <div class="info-value">ğŸ“ {{ enlevement.siteNom }}</div>
      </div>
      <div class="info-item" *ngIf="enlevement.camionMatricule">
        <label class="info-label">{{ 'enlevement.camion' | translate }}</label>
        <div class="info-value">ğŸšš {{ enlevement.camionMatricule }}</div>
      </div>
      <div class="info-item" *ngIf="enlevement.chauffeurNom">
        <label class="info-label">{{ 'enlevement.chauffeur' | translate }}</label>
        <div class="info-value">ğŸ‘¨â€âœˆï¸ {{ enlevement.chauffeurNom }}</div>
      </div>
      <div class="info-item full-width" *ngIf="enlevement.observation">
        <label class="info-label">{{ 'enlevement.observation' | translate }}</label>
        <div class="info-value">{{ enlevement.observation }}</div>
      </div>
    </div>
  </div>

  <!-- Destination -->
  <div class="info-card" *ngIf="enlevement.destinationId">
    <h2 class="card-title">ğŸ­ {{ 'enlevement.destination' | translate }}</h2>
    <div class="info-grid">
      <div class="info-item">
        <label class="info-label">{{ 'enlevement.raisonSociale' | translate }}</label>
        <div class="info-value">
          <strong>{{ enlevement.destinationRaisonSociale }}</strong>
        </div>
      </div>
      <div class="info-item">
        <label class="info-label">{{ 'enlevement.site' | translate }}</label>
        <div class="info-value">ğŸ“ {{ enlevement.destinationSite }}</div>
      </div>
      <div class="info-item" *ngIf="enlevement.dateDestination">
        <label class="info-label">{{ 'enlevement.dateArrivee' | translate }}</label>
        <div class="info-value">ğŸ“… {{ formatDate(enlevement.dateDestination) }}</div>
      </div>
      <div class="info-item" *ngIf="enlevement.heureDestination">
        <label class="info-label">{{ 'enlevement.heureArrivee' | translate }}</label>
        <div class="info-value">ğŸ• {{ formatTime(enlevement.heureDestination) }}</div>
      </div>
      <div class="info-item" *ngIf="enlevement.destinationNomInterlocuteur">
        <label class="info-label">{{ 'enlevement.contact' | translate }}</label>
        <div class="info-value">
          {{ enlevement.destinationNomInterlocuteur }}
          <span *ngIf="enlevement.destinationTelInterlocuteur"> - {{ enlevement.destinationTelInterlocuteur }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- DÃ©tails des dÃ©chets -->
  <div class="items-card">
    <h2 class="card-title">ğŸ“¦ {{ 'enlevement.detailsDechets' | translate }}</h2>
    <div class="table-wrapper">
      <table mat-table [dataSource]="enlevement.items || []" class="premium-table">
        <ng-container matColumnDef="typeDechet">
          <th mat-header-cell *matHeaderCellDef class="table-header">{{ 'enlevement.type' | translate }}</th>
          <td mat-cell *matCellDef="let item" class="table-cell">
            <span class="badge" [ngClass]="'badge-type-' + item.typeDechet.toLowerCase()">
              {{ getTypeDechetLabel(item.typeDechet) }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="sousType">
          <th mat-header-cell *matHeaderCellDef class="table-header">{{ 'enlevement.sousType' | translate }}</th>
          <td mat-cell *matCellDef="let item" class="table-cell">{{ item.sousType || '-' }}</td>
        </ng-container>

        <ng-container matColumnDef="quantiteKg">
          <th mat-header-cell *matHeaderCellDef class="table-header">{{ 'enlevement.quantite' | translate }}</th>
          <td mat-cell *matCellDef="let item" class="table-cell">{{ item.quantiteKg | number:'1.3-3' }} {{ item.uniteMesure || 'kg' }}</td>
        </ng-container>

        <ng-container matColumnDef="etat">
          <th mat-header-cell *matHeaderCellDef class="table-header">{{ 'enlevement.etat' | translate }}</th>
          <td mat-cell *matCellDef="let item" class="table-cell">{{ item.etat || '-' }}</td>
        </ng-container>

        <ng-container matColumnDef="prixUnitaireMad">
          <th mat-header-cell *matHeaderCellDef class="table-header">{{ 'enlevement.prixUnitaire' | translate }}</th>
          <td mat-cell *matCellDef="let item" class="table-cell">{{ item.prixUnitaireMad | number:'1.2-2' }} MAD / {{ item.uniteMesure || 'kg' }}</td>
        </ng-container>

        <ng-container matColumnDef="montant">
          <th mat-header-cell *matHeaderCellDef class="table-header">{{ 'enlevement.montant' | translate }}</th>
          <td mat-cell *matCellDef="let item" class="table-cell">
            <strong class="montant-value">{{ (item.quantiteKg * item.prixUnitaireMad) | number:'1.2-2' }} MAD</strong>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns" class="table-header-row"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns" class="table-row"></tr>
      </table>
    </div>
  </div>

  <!-- Totaux et statistiques -->
  <div class="totals-card">
    <h2 class="card-title">ğŸ’° {{ 'enlevement.totauxStats' | translate }}</h2>
    <div class="totals-grid">
      <div class="total-item">
        <label class="total-label">{{ 'enlevement.poidsTotal' | translate }}</label>
        <div class="total-value">{{ enlevement.poidsTotal | number:'1.1-1' }} kg</div>
      </div>
      <div class="total-item total-success">
        <label class="total-label">{{ 'enlevement.budgetRecyclage' | translate }}</label>
        <div class="total-value">+{{ enlevement.budgetRecyclage | number:'1.2-2' }} MAD</div>
      </div>
      <div class="total-item total-danger">
        <label class="total-label">{{ 'enlevement.budgetTraitement' | translate }}</label>
        <div class="total-value">-{{ enlevement.budgetTraitement | number:'1.2-2' }} MAD</div>
      </div>
      <div class="total-item" [ngClass]="'total-' + getBilanClass(enlevement.bilanNet)">
        <label class="total-label">{{ 'enlevement.bilanNet' | translate }}</label>
        <div class="total-value">
          {{ enlevement.bilanNet > 0 ? '+' : '' }}{{ enlevement.bilanNet | number:'1.2-2' }} MAD
        </div>
      </div>
      <div class="total-item">
        <label class="total-label">{{ 'enlevement.tauxRecyclage' | translate }}</label>
        <div class="total-value">
          <span class="badge" [ngClass]="'badge-taux-' + getTauxClass(enlevement.tauxRecyclage)">
            {{ enlevement.tauxRecyclage | number:'1.0-0' }}%
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Transactions associÃ©es -->
  <div class="transactions-card">
    <div class="transactions-header">
      <h2 class="card-title">ğŸ’° {{ 'enlevement.transactionsComptables' | translate }}</h2>
    </div>
    <div class="transactions-content">
      <div *ngIf="loadingTransactions" class="loading-transactions">
        <mat-spinner diameter="30"></mat-spinner>
        <span>{{ 'enlevement.loadingTransactions' | translate }}</span>
      </div>
      <div *ngIf="!loadingTransactions && transactions.length > 0" class="transactions-table-wrapper">
        <table mat-table [dataSource]="transactions" class="premium-table">
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef class="table-header">{{ 'enlevement.date' | translate }}</th>
            <td mat-cell *matCellDef="let transaction" class="table-cell">
              {{ transaction.dateTransaction | date:'dd/MM/yyyy' }}
            </td>
          </ng-container>
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef class="table-header">{{ 'enlevement.type' | translate }}</th>
            <td mat-cell *matCellDef="let transaction" class="table-cell">
              <span class="badge" [ngClass]="transaction.type === TypeTransaction.RECETTE ? 'badge-success' : 'badge-danger'">
                {{ getTransactionTypeLabel(transaction.type) }}
              </span>
            </td>
          </ng-container>
          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef class="table-header">{{ 'transaction.description' | translate }}</th>
            <td mat-cell *matCellDef="let transaction" class="table-cell">{{ transaction.description }}</td>
          </ng-container>
          <ng-container matColumnDef="montant">
            <th mat-header-cell *matHeaderCellDef class="table-header">{{ 'enlevement.montant' | translate }}</th>
            <td mat-cell *matCellDef="let transaction" class="table-cell amount-cell">
              <strong [ngClass]="transaction.type === TypeTransaction.RECETTE ? 'amount-positive' : 'amount-negative'">
                {{ transaction.type === TypeTransaction.RECETTE ? '+' : '-' }}{{ transaction.montant | number:'1.2-2' }} MAD
              </strong>
            </td>
          </ng-container>
          <ng-container matColumnDef="statut">
            <th mat-header-cell *matHeaderCellDef class="table-header">{{ 'transaction.statut' | translate }}</th>
            <td mat-cell *matCellDef="let transaction" class="table-cell">
              <span class="badge" [ngClass]="'badge-statut-' + transaction.statut.toLowerCase()">
                {{ getStatutLabel(transaction.statut) }}
              </span>
            </td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="table-header">{{ 'common.actions' | translate }}</th>
            <td mat-cell *matCellDef="let transaction" class="table-cell">
              <button 
                *ngIf="isComptable && transaction.montantRestant && transaction.montantRestant > 0"
                mat-icon-button 
                color="primary"
                (click)="openAddPaiementDialog(transaction)"
                [matTooltip]="'enlevement.addPaiement' | translate">
                <mat-icon>payment</mat-icon>
              </button>
              <button mat-icon-button (click)="viewTransaction(transaction.id)" [matTooltip]="'enlevement.viewDetail' | translate">
                <mat-icon>visibility</mat-icon>
              </button>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="transactionColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: transactionColumns;"></tr>
        </table>
      </div>
      <div *ngIf="!loadingTransactions && transactions.length === 0" class="empty-state">
        <mat-icon class="empty-icon">account_balance_wallet</mat-icon>
        <h3 class="empty-title">{{ 'enlevement.noTransactions' | translate }}</h3>
        <p class="empty-description">{{ 'enlevement.noTransactionsDesc' | translate }}</p>
      </div>
    </div>
  </div>

  <!-- Documents associÃ©s -->
  <div class="documents-card">
    <div class="documents-header">
      <h2 class="card-title">ğŸ“„ {{ 'enlevement.documentsAssocies' | translate }}</h2>
      <button mat-raised-button color="primary" class="upload-button" (click)="uploadDocument()">
        <mat-icon>cloud_upload</mat-icon>
        <span>{{ 'enlevement.uploadDocument' | translate }}</span>
      </button>
    </div>
    <div class="documents-content">
      <div *ngIf="loadingDocuments" class="loading-documents">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
      <div *ngIf="!loadingDocuments && documents.length > 0" class="documents-list">
        <div *ngFor="let doc of documents" class="document-item">
          <div class="document-info">
            <mat-icon class="document-icon">description</mat-icon>
            <div class="document-details">
              <strong class="document-name">{{ doc.fileName }}</strong>
              <small class="document-type">{{ doc.typeDocument }}</small>
            </div>
          </div>
          <div class="document-actions">
            <button mat-icon-button (click)="downloadDocument(doc)" [matTooltip]="'enlevement.download' | translate" class="action-button">
              <mat-icon>download</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="deleteDocument(doc)" [matTooltip]="'enlevement.delete' | translate" class="action-button">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>
      <div *ngIf="!loadingDocuments && documents.length === 0" class="empty-state">
        <mat-icon class="empty-icon">folder_off</mat-icon>
        <h3 class="empty-title">{{ 'enlevement.noDocuments' | translate }}</h3>
        <p class="empty-description">{{ 'enlevement.noDocumentsDesc' | translate }}</p>
        <button mat-raised-button color="primary" class="primary-button" (click)="uploadDocument()">
          <mat-icon>cloud_upload</mat-icon>
          <span>{{ 'enlevement.uploadFirstDocument' | translate }}</span>
        </button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="loading" class="loading-overlay">
  <mat-spinner diameter="50"></mat-spinner>
</div>
